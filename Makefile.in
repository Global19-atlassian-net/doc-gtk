# +----------------------------------------------------------------------+
# | PHP Version 4.0                                                      |
# +----------------------------------------------------------------------+
# | Copyright (c) 1997-2001 The PHP Group                                |
# +----------------------------------------------------------------------+
# | This source file is subject to version 2.02 of the PHP licience,     |
# | that is bundled with this package in the file LICENCE and is         |
# | avalible through the world wide web at                               |
# | http://www.php.net/license/2_02.txt.                                 |
# | If uou did not receive a copy of the PHP license and are unable to   |
# | obtain it through the world wide web, please send a note to          |
# | license@php.net so we can mail you a copy immediately                |
# +----------------------------------------------------------------------+
# | Authors: James Moore <jmoore@php.net>                                |
# +----------------------------------------------------------------------+

#
# $Id$
#

#
#  Makefile	Variables
#
VPATH=@srcdir@
srcdir=@srcdir@

#
# Programs
#
XSLTPROC=@XSLTPROC@
PHP=@PHP@
UDOCS=scripts/udocs

#
# Paths
#
PHPGTK_SRCDIR="@PHPGTK_SRCDIR@"
stylesheet_dir=@STYLESHEET_DIR@
LANG=@LANG@

#
# Default Variables
#
MODE="quick"
UDOCSTYLESHEET:="chunk"
PREFIX="gtk"
XMLFILES=
STYLESHEET=$(CHUNK_STYLESHEET)

#
# Dependencies
#
COMMON_DEPS=
HTML_DEPS=$(HTML_STYLESHEET) $(COMMON_DEPS)	
CHUNK_DEPS=$(COMMON_DEPS)
PHPWEB_DEPS=$(COMMON_DEPS)
TEST_DEPS=$(COMMON_DEPS)
MANUAL_DEPS=chapters.ent

#
# Default Rule
#
all: html

#
# Build	Aliases
#
bigmanual.html:	build/bigmanual.html
dist: build/manual-snapshot.tar.gz
genchapterents.php:	scripts/genchapterents.php
html: build/html/index.html
nochunk: bigmanual.html
phpweb:	build/php/index.php
text: build/manual.txt
util: custom.titlepage.xsl

mirror-files: build/php_gtk_manual_@LANG@.tar.gz \
	      build/php_gtk_manual_@LANG@.tar.bz2 \
	      build/php_gtk_manual_@LANG@.zip \
	      build/php_gtk_manual_@LANG@.html.gz \
	      build/php_gtk_manual_@LANG@.txt.gz

#
# Dependency Aliases
#
html.xsl: @STYLESHEET_DIR@/html.xsl
chunk.xsl: @STYLESHEET_DIR@/chunk.xsl
phpweb.xsl:	@STYLESHEET_DIR@/phpweb.xsl
common.xsl:	@STYLESHEET_DIR@/common.xsl
genchapterents.php:	scripts/genchapterents.php
udocs:	scripts/udocs
custom.titlepage.xsl: @STYLESHEET_DIR@/html/custom.titlepage.xsl

#
# Dependency Rules
#
@STYLESHEET_DIR@/html.xsl:	@STYLESHEET_DIR@/html.xsl.in ./config.status
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

@STYLESHEET_DIR@/chunk.xsl:	 @STYLESHEET_DIR@/chunk.xsl.in ./config.status
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

@STYLESHEET_DIR@/phpweb.xsl:  @STYLESHEET_DIR@/phpweb.xsl.in	./config.status
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

@STYLESHEET_DIR@/common.xsl:  @STYLESHEET_DIR@/common.xsl.in	./config.status
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

chapters.ent:
	@$(PHP) -q scripts/genchapterents.php > $@

#
# Forced Rules
#
.manual.xml: $(XMLFILES) $(MANUAL_DEPS) 
	touch .manual.xml

#
# Utility Rules
#
manual.xml: .manual.xml
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

scripts/udocs:
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

scripts/genchapterents.php:
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

Makefile: $(srcdir)/Makefile.in	./config.status
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

FORCE:

#
# Make Rules
#

@STYLESHEET_DIR@/html/custom.titlepage.xsl:	manual.xml
	$(SAXON) $(html_stylesheet_dir)/custom.titlepage.xml	$(DOCBOOKXSL)/template/titlepage.xsl > $@

build/manual.txt: bigmanual.html
	@mkdir -p build
	lynx -nolist -dump file:`pwd`/build/bigmanual.html > $@

build/php/index.php: manual.xml	$(PHPWEB_DEPS)
	@mkdir -p build/php
	$(XSLTPROC) $(stylesheet_dir)/phpweb.xsl manual.xml 

build/html/index.html: manual.xml $(CHUNK_DEPS)
	@mkdir -p build/html
	$(XSLTPROC) $(stylesheet_dir)/chunk.xsl manual.xml	

build/bigmanual.html: manual.xml $(HTML_DEPS)
	@mkdir -p build
	$(XSLTPROC) $(stylesheet_dir)/docbook.xsl manual.xml > $@

build/php_gtk_manual_@LANG@.zip: build/html/index.html
	@mkdir -p build
	(cd build/html; zip -q -9 ../../$@ *.html)

build/php_gtk_manual_@LANG@.tar.gz: build/html/index.html
	@mkdir -p build
	(cd build/html; tar -cf - *.html ) | gzip -9 > $@

build/php_gtk_manual_@LANG@.tar.bz2: build/html/index.html
	@mkdir -p build
	(cd build/html; tar -cf - *.html) | bzip2 -9 > $@

build/php_gtk_manual_@LANG@.html.gz: build/bigmanual.html
	@mkdir -p build
	gzip -c -9 $< > $@

build/php_gtk_manual_@LANG@.txt.gz: build/manual.txt
	@mkdir -p build
	gzip -c -9 $< > $@

updatexml:
ifeq "$(mode)" "update"
ifeq "$(stylesheet)" "phpweb"
	@$(UDOCS) -u -sphpweb
else
	@$(UDOCS) -u -schunk
endif
else
ifeq "$(stylesheet)" "phpweb"
	@$(UDOCS) -sphpweb
else
	@$(UDOCS) -schunk
endif
	
endif

#
# Generic Rules
#
.SUFFIXES: .xml

%.xml: udocs
ifeq "$(mode)" "update"
ifeq "$(stylesheet)" "phpweb"
	@$(UDOCS) -u -sphpweb $@
else
	@$(UDOCS) -u -schunk $@
endif
else
ifeq "$(stylesheet)" "phpweb"
	@$(UDOCS) -sphpweb $@
else
	@$(UDOCS) -schunk $@
endif
	
endif

#
# Clean	Rules
#
clean:
	rm -rf build
	rm -f chapters.ent

distclean: clean
	rm -f Makefile manual.xml configure
	rm -f config.cache config.log config.status version.ent
	cd scripts; rm -f genchapterents.php udocs

cvsclean:
	@for i in `find	. -name	.cvsignore`; do	\
		(cd	`dirname $$i` 2>/dev/null && rm	-rf	`cat .cvsignore` ||	true); \
	done



