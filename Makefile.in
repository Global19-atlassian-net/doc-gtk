# +----------------------------------------------------------------------+
# | PHP Version 4.0                                                      |
# +----------------------------------------------------------------------+
# | Copyright (c) 1997-2001 The PHP Group                                |
# +----------------------------------------------------------------------+
# | This source file is subject to version 2.02 of the PHP licience,     |
# | that is bundled with this package in the file LICENCE and is         |
# | avalible through the world wide web at                               |
# | http://www.php.net/license/2_02.txt.                                 |
# | If uou did not receive a copy of the PHP license and are unable to   |
# | obtain it through the world wide web, please send a note to          |
# | license@php.net so we can mail you a copy immediately                |
# +----------------------------------------------------------------------+
# | Authors: James Moore <jmoore@php.net>                                |
# +----------------------------------------------------------------------+

#
# $Id$
#

#
#  Makefile	Variables
#
VPATH=@srcdir@
srcdir=@srcdir@
LANG=@LANG@

#
# Paths
#
STYLESHEET_DIR=@STYLESHEET_DIR@
BUILD=build/@LANG@

#
# Programs
#
XSLTPROC=@XSLTPROC@
PHP=@PHP@
UDOCS=scripts/udocs

#
# Default Variables
#
MODE="quick"
UDOCSTYLESHEET:="chunk"
PREFIX="gtk"
XMLFILES=
STYLESHEET=$(CHUNK_STYLESHEET)

#
# Dependencies
#
COMMON_DEPS=
HTML_DEPS=$(HTML_STYLESHEET) $(COMMON_DEPS)	
CHUNK_DEPS=$(COMMON_DEPS)
PHPWEB_DEPS=$(COMMON_DEPS)
TEST_DEPS=$(COMMON_DEPS)
MANUAL_DEPS=chapters.ent

#
# Default Rule
#
all: html

#
# Build	Aliases
#
bigmanual.html:	$(BUILD)/bigmanual.html
dist: $(BUILD)/manual-snapshot.tar.gz
genchapterents.php:	scripts/genchapterents.php
html: $(BUILD)/html/index.html
nochunk: bigmanual.html
phpweb:	$(BUILD)/php/index.php
text: $(BUILD)/manual.txt
util: custom.titlepage.xsl

mirror-files: $(BUILD)/php_gtk_manual_$(LANG).tar.gz \
	      $(BUILD)/php_gtk_manual_$(LANG).tar.bz2 \
	      $(BUILD)/php_gtk_manual_$(LANG).zip \
	      $(BUILD)/php_gtk_manual_$(LANG).html.gz \
	      $(BUILD)/php_gtk_manual_$(LANG).txt.gz

#
# Dependency Aliases
#
html.xsl: $(STYLESHEET_DIR)/html.xsl
chunk.xsl: $(STYLESHEET_DIR)/chunk.xsl
phpweb.xsl:	$(STYLESHEET_DIR)/phpweb.xsl
common.xsl:	$(STYLESHEET_DIR)/common.xsl
genchapterents.php:	scripts/genchapterents.php
udocs:	scripts/udocs
custom.titlepage.xsl: $(STYLESHEET_DIR)/html/custom.titlepage.xsl

#
# Dependency Rules
#
$(STYLESHEET_DIR)/html.xsl:	@STYLESHEET_DIR@/html.xsl.in ./config.status
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

$(STYLESHEET_DIR)/chunk.xsl:	 @STYLESHEET_DIR@/chunk.xsl.in ./config.status
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

$(STYLESHEET_DIR)/phpweb.xsl:  @STYLESHEET_DIR@/phpweb.xsl.in	./config.status
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

$(STYLESHEET_DIR)/common.xsl:  @STYLESHEET_DIR@/common.xsl.in	./config.status
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

chapters.ent:
	@$(PHP) -q scripts/genchapterents.php > $@

#
# Forced Rules
#
.manual.xml: $(XMLFILES) $(MANUAL_DEPS) 
	touch .manual.xml

#
# Utility Rules
#
manual.xml: .manual.xml
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

scripts/udocs:
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

scripts/genchapterents.php:
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

Makefile: $(srcdir)/Makefile.in	./config.status
	CONFIG_FILES=$@	CONFIG_HEADERS=	./config.status

FORCE:

#
# Make Rules
#

$(STYLESHEET_DIR)/html/custom.titlepage.xsl:	manual.xml
	$(SAXON) $(STYLESHEET_DIR)/html/custom.titlepage.xml	$(DOCBOOKXSL)/template/titlepage.xsl > $@

$(BUILD)/manual.txt: bigmanual.html
	@mkdir -p $(BUILD)
	lynx -nolist -dump file:`pwd`/$(BUILD)/bigmanual.html > $@

$(BUILD)/php/index.php: manual.xml	$(PHPWEB_DEPS)
	@mkdir -p $(BUILD)/php
	$(XSLTPROC) --param base.dir "'$(BUILD)/php/'" $(STYLESHEET_DIR)/phpweb.xsl manual.xml 

$(BUILD)/html/index.html: manual.xml $(CHUNK_DEPS)
	@mkdir -p $(BUILD)/html
	$(XSLTPROC) --param base.dir "'$(BUILD)/html/'" $(STYLESHEET_DIR)/chunk.xsl manual.xml	

$(BUILD)/bigmanual.html: manual.xml $(HTML_DEPS)
	@mkdir -p $(BUILD)
	$(XSLTPROC) $(STYLESHEET_DIR)/docbook.xsl manual.xml > $(BUILD)/bigmanual.html

$(BUILD)/php_gtk_manual_$(LANG).zip: $(BUILD)/html/index.html
	@mkdir -p $(BUILD)
	(cd $(BUILD)/html; zip -q -9 - *.html) > $@

$(BUILD)/php_gtk_manual_$(LANG).tar.gz: $(BUILD)/html/index.html
	@mkdir -p $(BUILD)
	(cd $(BUILD)/html; tar -cf - *.html ) | gzip -9 > $@

$(BUILD)/php_gtk_manual_$(LANG).tar.bz2: $(BUILD)/html/index.html
	@mkdir -p $(BUILD)
	(cd $(BUILD)/html; tar -cf - *.html) | bzip2 -9 > $@

$(BUILD)/php_gtk_manual_$(LANG).html.gz: $(BUILD)/bigmanual.html
	@mkdir -p $(BUILD)
	gzip -c -9 $< > $@

$(BUILD)/php_gtk_manual_$(LANG).txt.gz: $(BUILD)/manual.txt
	@mkdir -p $(BUILD)
	gzip -c -9 $< > $@

updatexml:
ifeq "$(mode)" "update"
ifeq "$(stylesheet)" "phpweb"
	@$(UDOCS) -u -sphpweb
else
	@$(UDOCS) -u -schunk
endif
else
ifeq "$(stylesheet)" "phpweb"
	@$(UDOCS) -sphpweb
else
	@$(UDOCS) -schunk
endif
	
endif

#
# Generic Rules
#
.SUFFIXES: .xml

%.xml: udocs
ifeq "$(mode)" "update"
ifeq "$(stylesheet)" "phpweb"
	@$(UDOCS) -u -sphpweb $@
else
	@$(UDOCS) -u -schunk $@
endif
else
ifeq "$(stylesheet)" "phpweb"
	@$(UDOCS) -sphpweb $@
else
	@$(UDOCS) -schunk $@
endif
	
endif

#
# Clean	Rules
#
clean:
	rm -rf $(BUILD)
	rm -f chapters.ent

distclean: clean
	rm -f Makefile manual.xml configure
	rm -f config.cache config.log config.status version.ent
	cd scripts; rm -f genchapterents.php udocs

cvsclean:
	@for i in `find	. -name	.cvsignore`; do	\
		(cd	`dirname $$i` 2>/dev/null && rm	-rf	`cat .cvsignore` ||	true); \
	done



