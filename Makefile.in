# +----------------------------------------------------------------------+
# | PHP Version 4.0                                                      |
# +----------------------------------------------------------------------+
# | Copyright (c) 1999-2003 The PHP Group                                |
# +----------------------------------------------------------------------+
# | This source file is subject to version 3.0 of the PHP license,       |
# | that is bundled with this package in the file LICENSE and is         |
# | available online at http://www.php.net/license/3_0.txt.              |
# | If you did not receive a copy of the PHP license and are unable to   |
# | obtain it through the world wide web, please send a note to          |
# | license@php.net so we can mail you a copy immediately                |
# +----------------------------------------------------------------------+
# | Authors: James Moore <jmoore@php.net>                                |
# +----------------------------------------------------------------------+

#
# $Id$
#

#
# Paths
#
STYLESHEET_DIR = @STYLESHEET_DIR@
LANG = @LANG@
BUILD = build/@LANG@
BUILD_SEARCHABLE = htdocs
BUILD_TEST = testbuild

#
# Programs
#
XSLTPROC = @XSLTPROC@
PHP = @PHP@
HIGHLIGHT = scripts/html_syntax.php

#
# Default Rule
#
all: html

#
# Build Aliases
#
bigmanual.html: $(BUILD)/bigmanual.html
html: $(BUILD)/html/index.html
phpweb: $(BUILD)/php/index.php
searchable_zip: $(BUILD)/searchable_manual_$(LANG).zip
searchable_tar: $(BUILD)/searchable_manual_$(LANG).tar.gz
text: $(BUILD)/manual.txt
test: $(BUILD_TEST)/index.html
updates: $(BUILD_TEST)/updates.php

mirror-files:	$(BUILD)/php_gtk_manual_$(LANG).tar.gz \
				$(BUILD)/php_gtk_manual_$(LANG).tar.bz2 \
				$(BUILD)/php_gtk_manual_$(LANG).zip \
				$(BUILD)/php_gtk_manual_$(LANG).html.gz \
				$(BUILD)/php_gtk_manual_$(LANG).txt.gz

#
# Dependency Aliases
#
html = $(STYLESHEET_DIR)/html.xsl
chunk = $(STYLESHEET_DIR)/chunk.xsl
phpweb = $(STYLESHEET_DIR)/phpweb.xsl
common = $(STYLESHEET_DIR)/common.xsl
docbook = $(STYLESHEET_DIR)/docbook.xsl
updates = $(STYLESHEET_DIR)/updates.xsl

#
# Make Rules
#
$(BUILD)/manual.txt: bigmanual.html
	@mkdir -p $(BUILD)
	lynx -nolist -dump file:`pwd`/$(BUILD)/bigmanual.html > $@

$(BUILD)/php/index.php: manual.xml
	@mkdir -p $(BUILD)/php
	$(XSLTPROC) --param base.dir "'$(BUILD)/php/'" $(phpweb) manual.xml
	$(PHP) $(HIGHLIGHT) php $(BUILD)/php

$(BUILD)/html/index.html: manual.xml
	@mkdir -p $(BUILD)/html
	$(XSLTPROC) --param base.dir "'$(BUILD)/html/'" $(chunk) manual.xml

$(BUILD)/bigmanual.html: manual.xml
	@mkdir -p $(BUILD)
	$(XSLTPROC) $(docbook) manual.xml > $(BUILD)/bigmanual.html

$(BUILD_TEST)/updates.php: testclasses.xml
	@mkdir -p $(BUILD_TEST)
	$(XSLTPROC) $(updates) testmanual.xml > $(BUILD_TEST)/updates.php

$(BUILD)/php_gtk_manual_$(LANG).zip: $(BUILD)/html/index.html
	@mkdir -p $(BUILD)
	(cd $(BUILD)/html; zip -q -9 - *.html) > $@

$(BUILD)/php_gtk_manual_$(LANG).tar.gz: $(BUILD)/html/index.html
	@mkdir -p $(BUILD)
	(cd $(BUILD)/html; tar -cf - *.html ) | gzip -9 > $@

$(BUILD)/php_gtk_manual_$(LANG).tar.bz2: $(BUILD)/html/index.html
	@mkdir -p $(BUILD)
	(cd $(BUILD)/html; tar -cf - *.html) | bzip2 -9 > $@

$(BUILD)/php_gtk_manual_$(LANG).html.gz: $(BUILD)/bigmanual.html
	@mkdir -p $(BUILD)
	gzip -c -9 $< > $@

$(BUILD)/php_gtk_manual_$(LANG).txt.gz: $(BUILD)/manual.txt
	@mkdir -p $(BUILD)
	gzip -c -9 $< > $@

$(BUILD_TEST)/index.html: testmanual.xml
	@mkdir -p $(BUILD_TEST)
	$(XSLTPROC) --param base.dir "'$(BUILD_TEST)/'" $(chunk) testmanual.xml


#
# The 'searchable' builds should only ever be created LOCALLY!!!
#
$(BUILD_SEARCHABLE)/manual/index.php: manual.xml
	@mkdir -p $(BUILD_SEARCHABLE)/manual
	$(XSLTPROC) --param base.dir "'$(BUILD_SEARCHABLE)/manual/'" $(phpweb) manual.xml

$(BUILD)/searchable_manual_$(LANG).zip: $(BUILD_SEARCHABLE)/manual/index.php
	@mkdir -p $(BUILD)
	cp -r search/include search/gifs search/manual search/*.php $(BUILD_SEARCHABLE)
	zip -qrm -9 $@ $(BUILD_SEARCHABLE)

$(BUILD)/searchable_manual_$(LANG).tar.gz: $(BUILD_SEARCHABLE)/manual/index.php
	@mkdir -p $(BUILD)
	cp -r search/include search/gifs search/manual search/*.* $(BUILD_SEARCHABLE)
	tar -cf - $(BUILD_SEARCHABLE)/ | gzip -9 > $@
	rm -rf $(BUILD_SEARCHABLE)/

#
# Clean Rules
#
clean:
	rm -rf $(BUILD)
	rm -f chapters.ent
	rm -f testmanual.xml testclasses.xml

distclean: clean
	rm -f Makefile manual.xml configure
	rm -f config.cache config.log config.status version.ent
	cd scripts; rm -f genchapterents.php
	cd stylesheets/html; rm -f phpweb.xsl
	rm -rf $(BUILD_TEST)

cvsclean:
	@for i in `find . -name .cvsignore`; do \
		(cd `dirname $$i` 2>/dev/null && rm -rf `cat .cvsignore` || true); \
	done

